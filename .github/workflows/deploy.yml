name: Deploy Service

on:
  workflow_call:
    inputs:
      service-name:
        description: "Name of the service to deploy"
        required: true
        type: string
      env:
        description: "Environment (dev/staging/prod)"
        required: true
        type: string
      image-tag:
        description: "Docker image tag to deploy"
        required: true
        type: string

jobs:
  update-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: Parspec/parspec-ai-ci-common
          path: ci-cd-workflows-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update image tag in deployment file (safe)
        id: update
        run: |
            set -euo pipefail
            cd ci-cd-workflows-repo
        
            # Locate deployments dir
            if [ -d "deployment" ]; then
              DEPLOY_DIR="deployment"
            elif [ -d ".deployment" ]; then
              DEPLOY_DIR=".deployment"
            else
              echo "‚ùå Neither 'deployment' nor '.deployment' exists in $(pwd)"
              ls -la
              exit 1
            fi
        
            DEPLOY_FILE="$DEPLOY_DIR/table-parsing-service-dev.yml"  # or use inputs to build this
            [ -f "$DEPLOY_FILE" ] || { echo "‚ùå Missing $DEPLOY_FILE"; exit 1; }
        
            NEW_TAG="test_branch"  # or: NEW_TAG='${{ inputs.image-tag }}'
            [ -n "$NEW_TAG" ] || { echo "‚ùå image-tag is empty"; exit 1; }
        
            # Install yq
            sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64"
            sudo chmod +x /usr/local/bin/yq
        
            # Read current image from the Deployment doc only
            CUR_IMAGE=$(yq 'select(.kind == "Deployment") | .spec.template.spec.containers[0].image' "$DEPLOY_FILE")
            if [ -z "$CUR_IMAGE" ] || [ "$CUR_IMAGE" = "null" ]; then
              echo "‚ùå Could not read current image from the Deployment doc"
              exit 1
            fi
        
            # Build new image (preserve repo, swap only tag)
            if [[ "$CUR_IMAGE" == *:* ]]; then
              BASE="${CUR_IMAGE%:*}"
            else
              BASE="$CUR_IMAGE"
            fi
            NEW_IMAGE="${BASE}:${NEW_TAG}"
        
            echo "üîé File: $DEPLOY_FILE"
            echo "OLD: $CUR_IMAGE"
            echo "NEW: $NEW_IMAGE"
        
            if [ "$CUR_IMAGE" = "$NEW_IMAGE" ]; then
              echo "NO_CHANGE=1" >> $GITHUB_ENV
              # Still export vars for next step
              echo "DEPLOY_DIR=$DEPLOY_DIR"   >> $GITHUB_ENV
              echo "DEPLOY_FILE=$DEPLOY_FILE" >> $GITHUB_ENV
              exit 0
            fi
        
            # Update ONLY the Deployment document
            yq -i '(. | select(.kind == "Deployment")).spec.template.spec.containers[0].image = env(NEW_IMAGE)' "$DEPLOY_FILE"
        
            echo "üîÅ Diff:"
            git --no-pager diff -- "$DEPLOY_FILE" || true
        
            # Persist for next step
            echo "DEPLOY_DIR=$DEPLOY_DIR"   >> $GITHUB_ENV
            echo "DEPLOY_FILE=$DEPLOY_FILE" >> $GITHUB_ENV
        
      - name: Commit and push changes (only if modified)
        run: |
            set -euo pipefail
            cd ci-cd-workflows-repo
        
            # If previous step said no change, skip commit
            if [ "${NO_CHANGE:-}" = "1" ]; then
              echo "‚úÖ Nothing to commit (already up to date)."
              exit 0
            fi
        
            # Only commit if the file actually changed
            if git diff --quiet --exit-code -- "$DEPLOY_FILE"; then
              echo "‚ÑπÔ∏è No changes detected."
              exit 0
            fi
        
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$DEPLOY_FILE"
            git commit -m "chore: deploy table-parsing-service to dev @ ${NEW_TAG:-${{ inputs.image-tag }} } [skip ci]"
            git push origin main
        
